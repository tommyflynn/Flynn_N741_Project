---
title: Exploratory Network Analysis of Clinical Interactions in the ED
author:  
  - name: Tommy Flynn
    email: tjflynn@emory.edu
    affiliation: Emory University
    footnote: Corresponding Author
address:
    code: Emory University
    address: Repository (<https://github.com/tommyflynn/Flynn_N741_Project/tree/master/Flynn_Project>)
abstract: Patient acuity in the Emergency Department is triaged at the beginning of the care process using the Emergency Severity Index (ESI) metric. The ESI is presumed to predict resource consumption in the ED, and is a validated predictor of hospital admission for the majority of ED patients. It is not sensitive to non-medical patient characteristics, such as patient race, nor is it accountable to changes in patient condition over time. ED administrators and charge nurses are left with an impression of the unit that does not reveal the reality of current paitient conditions or ED resources being utilized. The lack of real-time ED resource and patient condition information creates opportunities for unrecognized patient deterioration, medical errors, increased wait times, and decreased patient satisfaction. An objective measurement of patient resource consumption that passively observes and calulates relative patient need in real-time would allow charge nurses and administrators to make informed decisions for effective, efficient, and safe patient care. This study tests a novel approach to measuring patient acuity (ED resource consumption) using real-time location system (RTLS) contact data and network analysis. This paper presents the approach and analytic results of several ED contact networks in relation to patient acuity (ESI)
  
bibliography: rfid_bib.bib
output: rticles::elsevier_article
---
```{r setup, include=FALSE, tidy=TRUE, warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy=TRUE, warning=FALSE, message=FALSE)
library(igraph)
library(haven)
library(tidyverse)
library(lubridate)
library(pander)
library(printr)
```

#Research Question & Specific Aims

- Can network analysis of clinical interactions between patients and staff provide insight into the complex Emergency Department patient care process? [@RN602]
Aim 1: Explore the network of clinical interactions in the ED between patients and staff to determine whether predictable patterns emerge in terms of centrality, density, and change over time. 
Aim 2: Test the assocaition between patient acuity and network position measure of eigenvector centrality of patient composite network, compared to the centrality of teh dynamic patient network (measure TBD).

#Background & Objectives

 Intelligent clinical monitoring software is not a new idea, but advancements in the field of data science continue to yield powerful new tools that may make such software a reality in the near future.[@RN253, @RN794] Real-time location systems (RTLS) are increasingly common in hospitals across the nation, especially in clinical areas where patient care and flow are both complex and time-sensitive, such as the Emergency Department (ED).[@RN257] A bird's-eye view of a busy urban ED might resemble a hive of frenzied bees, but as we have learned of beehives, patterns of work and interactions within EDs are necessarily purposed and complexly adaptive to the various needs of the system (or hive) as a whole.[@BEES] By leveraging the technology of RTLS and analytical power of netowrk analysis, future ED monitoring systems will provide ED leadership with real-time resource allocation and patient condition information. 
 The Emergency Severity Index (ESI) is a validated metric used to triage patients in US Emergency Departments.[@RN251] That triage nurse may decide to involve the charge nurse or a physician given various concerns about the patient. These interactions, observed and measured by the Real Time Location System (RTLS), continue as more patients are triaged, moved into patient rooms, and so on toward a vast and complex network of interactions. This web of care is likely to correlate with the amount and quality of care delivered to individual patients. 
- __The purpose of this study is to explore the network of clinical interactions that take place in the Emergency Department and describe the raltionship between those network variables and patient acuity.__ To study this relationship, received permission to analyse existing data that includes the following; the frequency and duration of all face-to-face interactions (patients, providers, nurses, technicians, & administrators) that occured in the ED for 81 12hr shifts, the location of those interactions, and individual patients' medical and demographic characteristics including acuity, chief complaint, gender, age, arrival mode, and disposition. The network structural characteristics will be assessed in relation to the industry standard acuity measure, the Emergency Severity Index (ESI), and potential confounding variables. Using this data will require specific knowledge of the R statistical packages, network analysis, and data science. See Tables 1-4 for my learning goals with respective action items, timeline, and outcomes. 

```{r read data}
# read in the edges
edges <- haven::read_sas("tommy_edges_2009.sas7bdat") 
# read in the node traits: nodes
nodes <- haven::read_sas("tommy_nodes_2009.sas7bdat")
# read in patient characteristics data: patients
patients <- haven::read_sas("tommyflynn_patient_info_2009.sas7bdat")
names(patients)
```
#Methods

```{r exploratory analysis}
# First, there is an issue with dates; each dataset has different set of shift dates
# Something strange with DATES across the three tbls...
PTS_d8s <- unique(patients$d8) 
Nodes_d8s <-  unique(nodes$d8)
Edges_D8s <-  unique(edges$D8)
alldates <- c(PTS_d8s, Nodes_d8s , Edges_D8s)
# length(alldates) answer= 131
alldates <- unique(alldates) 
# now there are 49 total unique dates across all three tbls (but only 35 in edges-so we will eventually limit to those only)

# Put tbls into the DATA layer  of ggplot (Patient = pts, Edges = edg, & Nodes = nds)
pts <- ggplot(data = patients)
edg <- ggplot(data = edges)
nds <- ggplot(data = nodes)

# Starting by visualizing & summarizing CONTINUOUS variables 
# for patients age
age_histogram <- pts + geom_histogram(aes(x = AGE), na.rm = TRUE, 
                               fill = "blue", color = "orange")

# Now look at patient age by shift
patients %>% group_by(Date = d8[(d8 %in% alldates)==TRUE]) %>% summarise(Mean_Age = mean(AGE), 
                                               SD_Age = sd(AGE), IQR = IQR(AGE)) -> Age_stats_byD8
# knitr::kable(Age_stats_byD8)
# str(Age_stats_byD8)

pts_acuity <- patients %>% filter(Acuity != "Not Recorded")
# ggplot(data = pts_acuity, mapping = aes(x = AGE, colour = shift_ampm)) +
  # geom_freqpoly()
am_pts <- pts_acuity %>% filter(shift_ampm == "am")
pm_pts <- pts_acuity %>% filter(shift_ampm == "pm")
black_pts <- pts_acuity %>% filter(Race == "Black")
white_pts <- pts_acuity %>% filter(Race == "White")


```



```{r spring cleaning, eval=FALSE}
# Add level names (if using facets) at the beginning
levels(patients$Acuity) <- c("Immediate", "Urgent", "Acute", "Not Sick", "Go Home")
# Data Layer
ggplot(data = patients, aes(x = variable , y = variable ))
# Geometry Layer
geom_jitter(alpha = 0.6)
# Facet Layer (Group by column)
facet_grid(.~groupingvariable)
# Stats Layer
stat_smooth(mehtod = "lm", se = F, col = "red")
# More aesthetics
  scale_y_continuous("Axis Name",
                   limits = c(2,6),
                   expand = c(0, 0)) +
  scale_x_continuous("X Axis Name", 
                     limits = c(4, 8),
                     expand = c(0, 0)) + 
    coord_equal() + 
    theme(panel.background = element_blank(),
          plot.background = element_blank(),
          legend.background = element_blank(),
          legend.key = element_blank(),
          strip.background = element_blank(),
          axis.text = element_text(colour = "black"),
          axis.ticks = element_line(colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = "black"),
          strip.text = element_blank(),
          panel.margin = unit(1, "lines")
          )

# 
```


```{r univariate analyses}
# what variables do we have?
tail(edges)
edge_vars <- names(edges)
print(edge_vars)
node_vars <- names(nodes)
pt_vars <- names(patients)
# print(all_vars)
# Subset edge variables of interest for analysis

# Subset node variables of interest for analysis

# Subset pt variables of interest for analysis

# Describe remaining variables (univariately)


```



#RTLS Data

This study applies a secondary data analysis design due to the exploritory nature of the research aims. Data was made available with permissions from the originating research team. The purpose of the original study was to describe contact characteristics between patients and staff in the ED of a busy urban hospital to inform cross-infection control measures. Data were collected using a radio-frequency identification system that triangulated patient and staff (nurses, providers, and ancillary staff) locations within the ED at Emory University Hospital Midtwon. Data for this secondary analysis were collected using a prospective, longitudinal, observational design with a random sampling of one day shift and one night shift per week for one year, July 1, 2009 to June 30, 2010. This strategy was chosen to minimize sampling bias related to seasonal or weekly fluctuations in census, acuity, and ED staffing changes. Although a total of 104 shifts were observed, the original research team retained only 81 shifts for reasons related to issues with the RFID system and study staff sick leave.[@RN1X] 
```{r assign datasets, echo=FALSE}
# patient demographics
g <- ggplot(patients) 
g + geom_count(aes(x = Race, y = Acuity))
# how many shifts?
shifts <- unique(edges$D8)
k <- length(shifts) #35
# print(k)
# how many participants?
n <- unique(nodes$ID)
length(n)
# print(n)

# participant title
# ggplot(data = nodes) + geom_bar(aes(x=participant_type, fill = participant_type)) + labs(title = "Participant Counts by Title")

```
#Results







Analysis Plan
=============

#Data Exploration & Cleaning
Data will be maintained in private repositories in the GitHub version control platform. Patient characteristic data will be evaluated for missing or implausible data with discriptive analyses, and RFID generated networks will be included for statistical analysis if variables of network density, centrality, and a network diversity scale are distributed normally across networks. 

Why do I find `r length(unique(nodes$sid))` unique nodes in the vertices data, `r length(unique(edges$sidi))` unique nodes in the edges dataset, and `r length(unique(patients$sid))` unique patients in the patient characteristics dataset? 
```{r}

```

Descriptive statistics of the network data as well as patient demographic data will be evaluated for asssumptions of normality. The data will be skewed in certain predictable ways due to the observed patient populations. The distribution of study subject demographics will be described in tabular format, noting irregularities and potential sources of error.
```{r acuity histogram, eval=FALSE}
patients <- patients %>%
 filter(Acuity != "Not Recorded")
ggplot(patients, aes(Acuity)) + geom_bar(aes(fill = Acuity))
```


```{r} 


```

##Variables available for final analysis:
__Network Variables__
>  - Network Centrality (based on the eigenvector up to, but not including, any other patient-staff interactions)
>  - Network density
>  - Network clustering coefficient


__Staff title__
>  - Title (RN, MD, Other Staff)

__Patient variables__
>  - *Acuity* (ESI, independant variable of interest)
>  - Gender
>  - Age
>  - Race
>  - Arrival mode (ambulance v. walk-in)
>  - Disposition (admission v. discharge)
>  - Length of stay (common measure of quality in the literature used for comparison)
  
##Analysis
The open-source R statistical language and R-Studio user interface from the developers at CRAN were used for all data exploration, wrangling, cleaning, description, and analysis.[@CRAN] Pandoc's Markdown allows for seemless integration of code, results, visualizations, and author interpretation of the research into a single document.[@MARKDOWN] Running all code and calculating all results within the menuscript itself, Markdown eliminates risk for errors in transferring statistical software output into foreign documents. The data were explored, cleaned, and assessed for statistical assumptions using the Tidyverse group of R packages.[@TIDY, @GGPLOT2] Data were prepared for network analysis with the iGraph package.[@IGRAPH]
Muliple linear regression will be used for the final analysis to assess the correlation between patient acuity and patient centrality. Relationships will be evaluated visually (see below) as well as statistically to an alpha of 0.05.
```{r prepare data for igraphs}
#prepare edges for transformation into igraph object (1st two rows are i & j)
edgesimple <- edges %>% select(sidi, sidj, D8, i_participant_type, j_participant_type) %>%
  filter(!is.na(i_participant_type) & !is.na(j_participant_type) | 
           !(i_participant_type == "_PAT" & j_participant_type == "_PAT"))

```

```{r igraph object}
# create an igraph object from the edges data frame (all 35 shifts)
g <- graph_from_data_frame(edgesimple, directed = FALSE)
plot(g, 
     vertex.label.color = "black", 
     edge.color = 'gray77',
     vertex.size = 0,
     layout = layout_nicely(g))

#create an igraph object from each individual shift
shift <- c(1:35)
#shiftdf <- data_frame(shift, shifts)
# str(shiftdf)
```

```{r}

```


Results
=======
Results will be discussed with the visual supplementation of network graphs. This allows the reader to understand concepts that may be difficult to grasp through text alone. 



Discussion
==========
Allocating staff resources in an Emergency Department is an ongoing challenge. How can these results begin to offer solutions to ED staff and patient management? 

What were my primary limitation (both expected and unexpected)?



Conclusion
==========
Did I meet my learning objectives? How would I design a better study next time? 




References {#references.unnumbered} 
==========




